{% extends "base.njk" %}

{% block content %}
<script>
  document.body.className = "void";
</script>

<article class="void">
  <header>
    <h1 class="mark-title">{{ title }}</h1>
    {% if subtitle %}<p class="subtitle">{{ subtitle }}</p>{% endif %}
  </header>

  {% if stave_image %}
  <figure class="stave">
    <img src="{{ stave_image }}" alt="Ritual stave for {{ title }}">
    <figcaption>Figure M-{{ mark_id }} — Transcribe to enter.</figcaption>
  </figure>
  {% endif %}

  <section id="seal" class="seal-box">
    <label for="pw" class="forgive-invocation">the characters to forgive:</label>
    <input id="pw" class="input input-dark" type="password" autocomplete="off" spellcheck="false" placeholder="">
    <button id="open" class="button button-dark">UNSEAL</button>
    <div id="fail" class="notice hidden">the seal holds. listen again.</div>
  </section>

  <!-- Unlocked payload -->
  <section id="unlocked" class="hidden">
    {% if audio_stream_url %}
    <h2>stream</h2>
    <div class="embed">
      <iframe src="{{ audio_stream_url }}" width="100%" height="140" frameborder="0"></iframe>
    </div>
    {% endif %}

    {% if download_url %}
    <p><a class="button button-dark" href="{{ download_url }}">download · mark {{ mark_id }}</a></p>
    {% endif %}

    {% if aria_abstract or dne_abstract %}
    <section class="abstracts">
      <h3>abstracts</h3>
      {% if aria_abstract %}<p><em>ARIA (sense):</em> {{ aria_abstract }}</p>{% endif %}
      {% if dne_abstract %}<p><em>DNE (antisense):</em> {{ dne_abstract }}</p>{% endif %}
    </section>
    {% endif %}

    {% if hypertext_link or library_link or treatise_link %}
    <section class="crosslinks">
      <h3>crosslinks</h3>
      <ul>
        {% if hypertext_link %}<li>cgms hypertext — <a href="{{ hypertext_link }}">enter</a></li>{% endif %}
        {% if library_link %}<li>library — <a href="{{ library_link }}">catalogue</a></li>{% endif %}
        {% if treatise_link %}<li>lexicomythography papers — <a href="{{ treatise_link }}">read</a></li>{% endif %}
      </ul>
    </section>
    {% endif %}
  </section>

  <!-- Recursive corruption field -->
  <section id="recursion-field" class="recursion" data-mark-id="{{ mark_id }}" aria-hidden="true"></section>
</article>

<script>
// SHA-256 ritual check (ceremonial, not cryptographically strong gating)
async function sha256(str){
  const enc = new TextEncoder().encode(str.trim());
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

const openBtn = document.getElementById('open');
const pwInput = document.getElementById('pw');
const fail = document.getElementById('fail');
const seal = document.getElementById('seal');
const unlocked = document.getElementById('unlocked');

openBtn?.addEventListener('click', async ()=>{
  const input = pwInput.value;
  const hash = await sha256(input);
  const target = "{{ password_hash | replace('sha256:', '') }}";
  if(hash === target){
    seal.classList.add('hidden');
    unlocked.classList.remove('hidden');
    document.body.classList.add('void-calm');
  }else{
    fail.classList.remove('hidden');
    document.dispatchEvent(new CustomEvent('forgive:fail'));
  }
});

// corruption engine
document.addEventListener('DOMContentLoaded', ()=>{
  const field = document.getElementById('recursion-field');
  if(!field) return;
  field.dataset.phrase = "the characters to forgive:";
  field.dataset.level = "{{ mark_id }}";
});
</script>
<script src="/assets/js/recursion.js" defer></script>
{% endblock %}